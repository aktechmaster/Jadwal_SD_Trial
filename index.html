<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jadwal Paralel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Header Control */
        .controls { display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; align-items: center; }
        select, button { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        button.primary { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button.primary:hover { background: #0056b3; }
        
        /* The Grid Table */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: top; }
        th { background: #343a40; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* Cell Inputs */
        .cell-input { display: flex; flex-direction: column; gap: 5px; }
        .cell-input select { width: 100%; font-size: 12px; padding: 5px; }
        .jam-label { font-weight: bold; font-size: 16px; }

        /* Status & Loading */
        #loading { display: none; color: #007bff; font-weight: bold; }
        .msg-box { margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; white-space: pre-line; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“… Input Jadwal Per Tingkat</h2>
    
    <div class="controls">
        <select id="pilihHari">
            <option value="">-- Pilih Hari --</option>
            <option value="Senin">Senin</option>
            <option value="Selasa">Selasa</option>
            <option value="Rabu">Rabu</option>
            <option value="Kamis">Kamis</option>
            <option value="Jumat">Jumat</option>
            <option value="Sabtu">Sabtu</option>
        </select>

        <select id="pilihTingkat" disabled>
            <option value="">-- Pilih Tingkat --</option>
            </select>

        <button class="primary" onclick="generateGrid()">Tampilkan Grid</button>
        <span id="loading">Memuat Data...</span>
    </div>

    <form id="formGrid">
        <div class="table-wrapper">
            <table id="gridTable">
                <thead>
                    <tr id="headerRow"><th>Jam Ke</th></tr>
                </thead>
                <tbody id="bodyTable">
                    <tr><td colspan="5">Silakan pilih Hari dan Tingkat Kelas terlebih dahulu.</td></tr>
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
            <button type="button" class="primary" id="btnSimpan" onclick="simpanData()" style="width: 200px; display:none;">ðŸ’¾ SIMPAN SEMUA</button>
        </div>
    </form>
    
    <div id="statusMsg" class="msg-box"></div>
</div>

<script>
    // ==========================================
    // PASTE URL DEPLOY ANDA DI SINI !!
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbw5RQDaS0GsHL1e7wYbojvfpsb-EwqzcfqMWv6GqGOB-IYKXnmw2kNxRvaIStaLMW1pKQ/exec";

    let GLOBAL_DATA = { kelas: [], mapel: [], guru: [] };

    // 1. Load Data Awal
    window.onload = function() {
        document.getElementById('loading').style.display = 'inline';
        fetch(API_URL + "?action=getMaster")
        .then(res => res.json())
        .then(res => {
            document.getElementById('loading').style.display = 'none';
            if(res.status === 'success') {
                GLOBAL_DATA = res.data;
                isiPilihanTingkat();
                document.getElementById('pilihTingkat').disabled = false;
            }
        });
    };

    // Fungsi Mengelompokkan Kelas (Misal 7.1, 7.2 jadi "Tingkat 7")
    function isiPilihanTingkat() {
        const uniqueLevels = new Set();
        GLOBAL_DATA.kelas.forEach(k => {
            let level = k.split('.')[0]; // Ambil angka depan (6 dari 6.1)
            if(level) uniqueLevels.add(level);
        });
        
        const select = document.getElementById('pilihTingkat');
        Array.from(uniqueLevels).sort().forEach(lvl => {
            let opt = document.createElement('option');
            opt.value = lvl;
            opt.text = "Kelas " + lvl; // Tampil sebagai "Kelas 6"
            select.appendChild(opt);
        });
    }

    // 2. Generate Grid (Tabel)
    function generateGrid() {
        const hari = document.getElementById('pilihHari').value;
        const tingkat = document.getElementById('pilihTingkat').value;

        if(!hari || !tingkat) {
            alert("Pilih Hari dan Tingkat Kelas dulu!");
            return;
        }

        // Filter Kelas sesuai Tingkat (Misal pilih 6 -> dapat 6.1, 6.2, 6.3)
        const kelasTerpilih = GLOBAL_DATA.kelas.filter(k => k.startsWith(tingkat + "."));
        
        if(kelasTerpilih.length === 0) {
            alert("Tidak ada data kelas untuk tingkat ini.");
            return;
        }

        // Buat Header Tabel
        const headerRow = document.getElementById('headerRow');
        headerRow.innerHTML = "<th>Jam</th>"; // Reset
        kelasTerpilih.forEach(k => {
            headerRow.innerHTML += `<th>${k}</th>`;
        });

        // Buat Body Tabel (Jam 1 sampai 10)
        const bodyTable = document.getElementById('bodyTable');
        bodyTable.innerHTML = ""; // Bersihkan

        // Siapkan Opsi Dropdown Guru & Mapel sekali saja biar ringan
        const opsiMapel = GLOBAL_DATA.mapel.map(m => `<option value="${m}">${m}</option>`).join('');
        const opsiGuru = GLOBAL_DATA.guru.map(g => `<option value="${g}">${g}</option>`).join('');

        for (let jam = 1; jam <= 10; jam++) {
            let tr = document.createElement('tr');
            
            // Kolom Jam
            tr.innerHTML = `<td class="jam-label">${jam}</td>`;

            // Kolom Per Kelas
            kelasTerpilih.forEach(k => {
                // Kita beri ID unik ke setiap input: jam-kelas-jenis
                // Contoh: mapel-1-6.1
                tr.innerHTML += `
                    <td>
                        <div class="cell-input">
                            <select name="mapel-${jam}-${k}">
                                <option value="" style="color:#ccc">-- Mapel --</option>
                                ${opsiMapel}
                            </select>
                            <select name="guru-${jam}-${k}">
                                <option value="" style="color:#ccc">-- Guru --</option>
                                ${opsiGuru}
                            </select>
                        </div>
                    </td>
                `;
            });
            bodyTable.appendChild(tr);
        }

        document.getElementById('btnSimpan').style.display = 'inline-block';
        document.getElementById('statusMsg').style.display = 'none';
    }

    // 3. Simpan Data (Bulk)
    function simpanData() {
        const btn = document.getElementById('btnSimpan');
        const statusBox = document.getElementById('statusMsg');
        const form = document.getElementById('formGrid');
        const hari = document.getElementById('pilihHari').value;
        
        btn.disabled = true;
        btn.innerText = "Sedang Menyimpan...";
        statusBox.style.display = 'none';

        // Kumpulkan data dari Grid
        let dataKirim = [];
        const inputs = form.querySelectorAll('select');
        
        // Kita butuh mapping input kembali ke struktur data
        // Format name: "jenis-jam-kelas" (contoh: mapel-1-6.1)
        
        let tempObj = {}; // { "1-6.1": {mapel:..., guru:...} }

        inputs.forEach(input => {
            if(!input.value) return; // Lewati yang kosong

            const parts = input.name.split('-'); // [jenis, jam, kelas]
            const jenis = parts[0]; // mapel / guru
            const jam = parts[1];
            const kelas = parts[2]; // Bisa jadi "6.1" atau "6.2" dll
            const key = `${jam}-${kelas}`;

            if(!tempObj[key]) tempObj[key] = { hari: hari, jam: jam, kelas: kelas };
            tempObj[key][jenis] = input.value;
        });

        // Ubah object ke array siap kirim
        for (let key in tempObj) {
            let item = tempObj[key];
            // Hanya kirim jika pasangan Mapel & Guru terisi lengkap (Opsional, tergantung kebijakan)
            if(item.guru && item.mapel) {
                dataKirim.push(item);
            }
        }

        if(dataKirim.length === 0) {
            alert("Isi minimal satu jadwal (Mapel & Guru) sebelum menyimpan.");
            btn.disabled = false;
            btn.innerText = "ðŸ’¾ SIMPAN SEMUA";
            return;
        }

        console.log("Mengirim data:", dataKirim);

        // Kirim ke Backend
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(dataKirim)
        })
        .then(res => res.json())
        .then(res => {
            btn.disabled = false;
            btn.innerText = "ðŸ’¾ SIMPAN SEMUA";
            statusBox.style.display = 'block';
            
            if(res.status === 'success') {
                statusBox.className = 'msg-box success';
                statusBox.innerText = res.message;
            } else {
                statusBox.className = 'msg-box error';
                statusBox.innerText = res.message;
            }
        })
        .catch(err => {
            btn.disabled = false;
            console.error(err);
            alert("Gagal koneksi server.");
        });
    }
</script>

</body>
</html>
